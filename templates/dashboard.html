{% extends 'layout.html' %}

{% block title %}Tableau de bord - {{ app_name }}{% endblock %}

{% block head_extra %}
<style>
    /* Styles pour les stat cards */
    .stat-card .card-body { padding: 1rem; }
    .stat-card .text-xs { font-size: 0.7rem; text-transform: uppercase; font-weight: 600; }
    .stat-card .h5 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0; }
    .stat-card .fa-2x { font-size: 2rem; opacity: 0.3; }
    .border-left-primary .fa-2x { color: var(--primary); }
    .border-left-success .fa-2x { color: var(--success); }
    .border-left-warning .fa-2x { color: var(--warning); }
    .border-left-danger .fa-2x { color: var(--danger); }
    .border-left-info .fa-2x { color: var(--info); }

    /* Styles pour la table des sessions */
    .session-table th, .session-table td { padding: 0.5rem 0.6rem; font-size: 0.825rem; vertical-align: middle; }
    .session-table th { font-weight: 600; background-color: var(--bs-light); border-bottom: 2px solid #dee2e6; }
    .session-table .theme-cell .theme-badge { font-size: 0.75rem; }
    .session-table .places-dispo i.fas { font-size: 0.9em; }
    .session-table .btn-sm { padding: 0.2rem 0.4rem; font-size: 0.7rem; }
    .session-table .btn-sm i.fas { margin-right: 0.2em; }
    .session-table .pending-count { font-weight: bold; color: #ff9800; }

    /* Styles pour les graphiques statiques */
    .static-chart-container { width: 100%; min-height: 300px; padding: 1.25rem; background-color: var(--white); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); margin-bottom: 1.5rem; overflow: hidden; display: flex; flex-direction: column; }
    .static-chart-title { font-size: 0.9rem; font-weight: 600; color: var(--dark); margin-bottom: 1rem; padding-bottom: 0.6rem; text-align: center; border-bottom: 1px solid #e9ecef; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .static-chart-donut-svg-container { display: flex; justify-content: center; align-items: center; margin: 0.75rem auto 1rem; position: relative; }
    .donut-svg { width: 160px; height: 160px; transform: rotate(-90deg); border-radius: 50%; overflow: visible;}
    .donut-svg-segment { transition: opacity 0.2s ease, stroke-width 0.2s ease; cursor: default; }
    .donut-svg-segment:hover { stroke-opacity: 0.8; /* stroke-width: 5.5; */ }
    .donut-svg-center-text { font-family: 'Segoe UI', sans-serif; text-anchor: middle; dominant-baseline: middle; }
    .donut-svg-center-text .donut-total { font-size: 10px; font-weight: 700; fill: var(--dark); }
    .donut-svg-center-text .donut-label { font-size: 3.5px; fill: var(--secondary); text-transform: uppercase; letter-spacing: 0.5px; }

    .static-chart-legend { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 0.4rem 0.8rem; padding: 0.5rem 0; font-size: 0.75rem; margin-top: auto; }
    .legend-item { display: flex; align-items: center; padding: 0.25rem 0.5rem; background-color: #f8f9fa; border-radius: 0.25rem; cursor: default; }
    .legend-color { width: 10px; height: 10px; border-radius: 3px; margin-right: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); flex-shrink: 0; }
    .legend-label { font-weight: 500; color: var(--dark); white-space: nowrap; }
    .legend-value { margin-left: 0.4rem; padding: 0.1rem 0.4rem; background-color: #e9ecef; border-radius: 8px; font-size: 0.65rem; font-weight: 600; color: var(--dark); }
    
    .static-chart-bars { width: 100%; padding-top: 0.75rem; flex-grow: 1; }
    .bar-item { margin-bottom: 0.8rem; position: relative; }
    .bar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
    .bar-label { font-size: 0.8rem; font-weight: 500; color: var(--dark); display: flex; align-items: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: calc(100% - 40px); }
    .service-badge { width: 10px; height: 10px; display: inline-block; border-radius: 50%; margin-right: 6px; flex-shrink: 0; }
    .bar-total { font-size: 0.75rem; font-weight: 600; color: var(--primary); background-color: rgba(0, 120, 212, 0.08); padding: 0.15rem 0.45rem; border-radius: 10px; min-width: 25px; text-align: center; flex-shrink: 0; }
    .bar-container { height: 6px; background-color: #e9ecef; border-radius: 3px; position: relative; overflow: hidden; box-shadow: inset 0 1px 1px rgba(0,0,0,0.05); }
    .bar-value { height: 100%; border-radius: 3px; position: relative; }

    .no-data-message { text-align: center; padding: 2rem; color: var(--secondary); font-style: italic; }
    .no-data-message i.fas.fa-spinner { font-size: 1.8rem; margin-bottom: 0.75rem; display: block; }
    .no-data-message i.fas.fa-info-circle { font-size: 1.8rem; margin-bottom: 0.75rem; display: block; }

    .activity-container { max-height: 320px; overflow-y: auto; padding: 0.25rem; }
    .activity-item { padding: 0.75rem 1rem; margin-bottom: 0.6rem; border-left-width: 4px; background-color: var(--white); border-radius: 0 var(--border-radius) var(--border-radius) 0; box-shadow: var(--shadow-sm); display: flex; align-items: flex-start; text-decoration: none; }
    .activity-item:hover { background-color: #f8f9fa; }
    .activity-icon { margin-right: 0.8rem; margin-top: 0.15rem; font-size: 0.9rem; width: 1.5em; text-align: center; opacity: 0.8; }
    .activity-title { font-weight: 500; font-size: 0.85rem; color: var(--dark); margin-bottom: 0.15rem; line-height: 1.35; }
    .activity-details { font-size: 0.75rem; color: var(--secondary); line-height: 1.4; word-break: break-word; }
    .activity-time { font-size: 0.7rem; white-space: nowrap; margin-left: 0.5rem; }

    /* Styles spécifiques aux demandes en attente */
    .validation-badge {
        padding: 0.25em 0.6em;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50rem;
    }
    .validation-badge i {
        margin-right: 0.35em;
    }
    
    /* Styles pour les modales */
    .modal-fix {
        z-index: 1055 !important;
    }
    .modal-fix .modal-dialog {
        z-index: 1056 !important;
    }
    .modal-fix .modal-content {
        z-index: 1057 !important;
    }
    .modal-fix select, 
    .modal-fix .form-select, 
    .modal-fix input:not([type="hidden"]), 
    .modal-fix textarea {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 1060 !important;
    }
    .modal-fix .form-select,
    .modal-fix select {
        -webkit-appearance: menulist !important;
        appearance: menulist !important;
    }
    .modal-fix .nav-tabs,
    .modal-fix .tab-content,
    .modal-fix .tab-pane {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    .modal-fix .tab-pane:not(.active) {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800"><i class="fas fa-tachometer-alt me-2"></i>Tableau de bord</h1>
    <div>
        <button id="refresh-dashboard" class="btn btn-sm btn-primary">
            <i class="fas fa-sync-alt me-1"></i>Actualiser
        </button>
    </div>
</div>

<!-- Statistiques globales -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow-sm h-100 py-2 stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col me-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Inscriptions Confirmées</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <span id="total-inscriptions" class="counter-value">{{ total_inscriptions|default(0) }}</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-primary-light"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow-sm h-100 py-2 stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col me-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Demandes En Attente</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <span id="total-en-attente" class="counter-value">{{ total_en_attente|default(0) }}</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-warning-light"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow-sm h-100 py-2 stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col me-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Sessions Totales</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <span id="total-sessions" class="counter-value">{{ sessions_data|length|default(0) }}</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-alt fa-2x text-info-light"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-danger shadow-sm h-100 py-2 stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col me-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Sessions Complètes</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <span id="total-sessions-completes" class="counter-value">{{ total_sessions_completes|default(0) }}</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-flag-checkered fa-2x text-danger-light"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-7 col-lg-6 mb-4">
        <!-- Sessions à venir -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-calendar-check me-2"></i>Sessions à venir</h6>
                <a href="{{ url_for('sessions') }}" class="btn btn-sm btn-outline-primary">Voir toutes les sessions</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 session-table">
                        <thead>
                            <tr>
                                <th>Date / Horaire</th>
                                <th>Thème</th>
                                <th>Places</th>
                                <th>En attente</th> <!-- Nouvelle colonne pour les demandes en attente -->
                                <th>Salle</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if sessions_data and sessions_data|length > 0 %}
                                {% for session_item in sessions_data %}
                                <tr>
                                    <td>
                                        <div class="fw-bold">{{ session_item.obj.formatage_date }}</div>
                                        <small class="text-muted">{{ session_item.obj.formatage_horaire }}</small>
                                    </td>
                                    <td class="theme-cell">
                                        <span class="theme-badge" data-theme="{{ session_item.obj.theme.nom }}">
                                            {{ session_item.obj.theme.nom }}
                                        </span>
                                    </td>
                                    <td class="places-dispo">
                                        {% if session_item.places_restantes > 0 %}
                                            <span class="text-success fw-bold">
                                                <i class="fas fa-circle me-1"></i>{{ session_item.inscrits_confirmes_count }}/{{ session_item.obj.max_participants }}
                                            </span>
                                            <div class="small text-muted">{{ session_item.places_restantes }} place(s) disponible(s)</div>
                                        {% else %}
                                            <span class="text-danger fw-bold">
                                                <i class="fas fa-times-circle me-1"></i>Complet
                                            </span>
                                            <div class="small text-danger">{{ session_item.liste_attente_count }} en liste d'attente</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if session_item.pending_count > 0 %}
                                            <span class="validation-badge bg-warning text-dark">
                                                <i class="fas fa-exclamation-circle"></i>{{ session_item.pending_count }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if session_item.obj.salle %}
                                            <span class="badge bg-light text-dark">{{ session_item.obj.salle.nom }}</span>
                                        {% else %}
                                            <span class="text-muted">Non définie</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#participantsModal_{{ session_item.obj.id }}" 
                                                    title="Voir participants">
                                                <i class="fas fa-users"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-success" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#inscriptionModal_{{ session_item.obj.id }}" 
                                                    title="Inscrire">
                                                <i class="fas fa-plus-circle"></i>
                                            </button>
                                            {% if current_user.is_authenticated and current_user.role == 'admin' %}
                                            <button type="button" class="btn btn-outline-secondary" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#attribuerSalleModal_{{ session_item.obj.id }}" 
                                                    title="Attribuer salle">
                                                <i class="fas fa-door-open"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <i class="fas fa-calendar-times fa-2x mb-2 d-block text-muted"></i>
                                        <p class="mb-0 text-muted">Aucune session à venir</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Validations en attente -->
        {% if current_user.is_authenticated and (current_user.role == 'admin' or current_user.role == 'responsable') and pending_validations|length > 0 %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3"><h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-clipboard-check me-2"></i>Validations en attente</h6></div>
            <div class="card-body p-0"><div class="table-responsive"><table class="table table-hover mb-0"><thead class="table-light"><tr><th>Participant</th><th>Session</th><th>Date d'inscription</th><th>Actions</th></tr></thead><tbody>
            {% for inscription in pending_validations %}
            <tr>
                <td>{{ inscription.participant.prenom }} {{ inscription.participant.nom }} <span class="badge" style="background-color: {{ inscription.participant.service.couleur }}; color: white;">{{ inscription.participant.service.nom }}</span></td>
                <td><span class="theme-badge" data-theme="{{ inscription.session.theme.nom }}">{{ inscription.session.theme.nom }}</span><small class="d-block text-muted">{{ inscription.session.formatage_date }} à {{ inscription.session.formatage_horaire }}</small></td>
                <td>{{ inscription.date_inscription.strftime('%d/%m/%Y %H:%M') }}</td>
                <td><div class="btn-group btn-group-sm">
                    <form action="{{ url_for('validation_inscription', inscription_id=inscription.id) }}" method="post" class="me-1"><input type="hidden" name="action" value="valider"><button type="submit" class="btn btn-success"><i class="fas fa-check me-1"></i>Valider</button></form>
                    <form action="{{ url_for('validation_inscription', inscription_id=inscription.id) }}" method="post"><input type="hidden" name="action" value="refuser"><button type="submit" class="btn btn-danger"><i class="fas fa-times me-1"></i>Refuser</button></form>
                </div></td>
            </tr>
            {% endfor %}
            </tbody></table></div></div>
        </div>
        {% endif %}
    </div>

    <div class="col-xl-5 col-lg-6 mb-4">
        <!-- Graphique Répartition des inscriptions par Thème -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3"><h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-chart-pie me-2"></i>Répartition des inscriptions</h6></div>
            <div class="card-body static-chart-container" id="themeChartStatic">
                {% if chart_theme_data is defined and chart_theme_data %}
                    {% set total_inscriptions_theme = chart_theme_data|sum(attribute='1') %}
                    {% if total_inscriptions_theme > 0 %}
                        <div class="static-chart-title">INSCRIPTIONS PAR THÈME</div>
                        <div class="static-chart-donut-svg-container">
                            <svg viewBox="0 0 42 42" class="donut-svg" width="160" height="160" aria-labelledby="chartTitle_themes_static" role="img">
                                <title id="chartTitle_themes_static">Répartition des inscriptions par thème</title>
                                {% set stroke_width = 5 %}
                                {% set radius = 15.9154943092 %}
                                {% set circumference = 100 %} {# Travailler avec une circonférence de 100 pour les pourcentages #}
                                {% set current_offset_angle = 0 %} {# Offset en degrés pour la rotation de chaque segment #}

                                {% for theme_name, count in chart_theme_data %}
                                    {% if count > 0 %}
                                        {% set percentage = (count / total_inscriptions_theme) * 100 %}
                                        {% set theme_config = themes_config.get(theme_name, {}) %}
                                        {% set color = theme_config.color or '#6c757d' %}
                                        <circle class="donut-svg-segment"
                                                cx="21" cy="21" r="{{ radius }}"
                                                fill="transparent"
                                                stroke="{{ color }}"
                                                stroke-width="{{ stroke_width }}"
                                                stroke-dasharray="{{ percentage }} {{ 100 - percentage }}"
                                                transform="rotate({{ current_offset_angle }} 21 21)">
                                            <title>{{ theme_name|escape }}: {{ count }} ({{ "%.1f"|format(percentage) }}%)</title>
                                        </circle>
                                        {% set current_offset_angle = current_offset_angle + (percentage * 3.6) %}
                                    {% endif %}
                                {% endfor %}
                                <g class="donut-svg-center-text" transform="rotate(90 21 21)">
                                    <text x="21" y="21" style="font-size:7px;">
                                        <tspan class="donut-total" x="21" dy="-0.2em">{{ total_inscriptions_theme }}</tspan>
                                        <tspan class="donut-label" x="21" dy="1.2em">INSCRITS</tspan>
                                    </text>
                                </g>
                            </svg>
                        </div>
                        <div class="static-chart-legend">
                            {% for theme_name, count in chart_theme_data %}
                                {% if count > 0 %}
                                    {% set theme_config = themes_config.get(theme_name, {}) %}
                                    {% set color = theme_config.color or '#6c757d' %}
                                    <div class="legend-item" title="{{ theme_config.description|default(theme_name, true)|escape }}">
                                        <span class="legend-color" style="background-color: {{ color }};"></span>
                                        <span class="legend-label">{{ theme_name|escape }}</span>
                                        <span class="legend-value">{{ count }}</span>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="no-data-message"><i class="fas fa-info-circle"></i>Aucune inscription pour afficher la répartition.</div>
                    {% endif %}
                {% else %}
                    <div class="no-data-message"><i class="fas fa-spinner fa-spin"></i>Chargement des données des thèmes...</div>
                {% endif %}
            </div>
        </div>

        <!-- Graphique Distribution par service -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3"><h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-chart-bar me-2"></i>Distribution par service</h6></div>
            <div class="card-body static-chart-container" id="serviceChartStatic">
                {% if chart_service_data is defined and chart_service_data %}
                    {% set total_participants_service = chart_service_data|sum(attribute='1.count') %}
                    {% if total_participants_service > 0 %}
                        <div class="static-chart-title">PARTICIPANTS PAR SERVICE</div>
                        <div class="static-chart-bars">
                            {% set max_count_service = (chart_service_data|map(attribute='1.count')|max) if chart_service_data else 1 %}
                            {% for service_name, data in chart_service_data %}
                                {% if data.count > 0 %}
                                    {% set percentage = (data.count / max_count_service) * 100 %}
                                    <div class="bar-item">
                                        <div class="bar-header">
                                            <span class="bar-label" title="{{ service_name|escape }} ({{ data.count }} participant(s))">
                                               <span class="service-badge me-2" style="background-color: {{ data.color }};"></span>
                                               {{ service_name|escape }}
                                            </span>
                                            <span class="bar-total">{{ data.count }}</span>
                                        </div>
                                        <div class="bar-container">
                                            <div class="bar-value" style="width: {{ percentage }}%; background-color: {{ data.color }};"></div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                         <div class="no-data-message"><i class="fas fa-info-circle"></i>Aucun participant pour afficher la distribution.</div>
                    {% endif %}
                {% else %}
                    <div class="no-data-message"><i class="fas fa-spinner fa-spin"></i>Chargement des données des services...</div>
                {% endif %}
            </div>
        </div>

        <!-- Activités récentes -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-history me-2"></i>Activités récentes</h6>
                <a href="{{ url_for('activites_journal') }}" class="btn btn-sm btn-outline-secondary">Voir toute l'activité</a>
            </div>
            <div class="card-body p-0">
                <div class="activity-container list-group list-group-flush" id="recent-activity">
                    {% if initial_activities is defined and initial_activities %}
                        {% for activity in initial_activities %}
                            <a href="{{ url_for('activites_journal', type=activity.type) }}" class="list-group-item list-group-item-action activity-item type-{{ activity.type|default('default') }}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1 activity-title">
                                        <i class="{{ getActivityIcon(activity.type) }} me-2 activity-icon"></i>
                                        {{ activity.description|escape }}
                                        {% if activity.user %}<span class="text-primary fw-bold ms-1">({{ activity.user|escape }})</span>{% endif %}
                                    </h6>
                                    <small class="text-muted activity-time">{{ activity.date_relative }}</small>
                                </div>
                                {% if activity.details %}<p class="mb-1 activity-details"><small>{{ activity.details|escape }}</small></p>{% endif %}
                            </a>
                        {% endfor %}
                    {% elif initial_activities is defined and not initial_activities %}
                         <div class="list-group-item text-center p-3 text-muted no-data-message">
                            <i class="fas fa-info-circle"></i>Aucune activité récente.
                        </div>
                    {% else %}
                        <div class="list-group-item text-center p-3 text-muted no-data-message">
                            <i class="fas fa-spinner fa-spin"></i>Chargement des activités récentes...
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Container pour les modales dynamiques -->
<div id="modalContainer"></div>
{% endblock %}

{% block modals %}
    {# S'assurer que sessions_data est la bonne variable ici, ou celle qui contient les objets Session #}
    {% if sessions_data and sessions_data|length > 0 %}
        {% for session_item_modal_data in sessions_data %}
            {% set session_obj_for_modal = session_item_modal_data.obj %}
            {% set session_data_for_modal_dict = session_item_modal_data %}
            
            {# Modal Inscription #}
            <div class="modal fade modal-fix" id="inscriptionModal_{{ session_obj_for_modal.id }}" tabindex="-1" 
                aria-labelledby="inscriptionModalLabel_{{ session_obj_for_modal.id }}" aria-hidden="true" 
                data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="inscriptionModalLabel_{{ session_obj_for_modal.id }}">
                            <i class="fas fa-user-plus me-2"></i>Inscription: {{ session_obj_for_modal.theme.nom }}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
                        </div>
                        <div class="modal-body p-4">
                            <!-- Informations sur la session -->
                            <div class="alert alert-light border mb-4 p-3 shadow-sm">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar-check fa-2x me-3 text-primary-emphasis"></i>
                                <div>
                                    <h6 class="mb-1 fw-bold text-primary-emphasis">Session du {{ session_obj_for_modal.formatage_date }}</h6>
                                    <p class="mb-1 small text-body-secondary">
                                        <i class="far fa-clock fa-fw me-1"></i>Horaire: {{ session_obj_for_modal.formatage_horaire }}
                                    </p>
                                    <p class="mb-1 small text-body-secondary">
                                        <i class="fas fa-chair fa-fw me-1"></i>Places disponibles: 
                                        <strong class="badge {% if session_data_for_modal_dict.places_restantes == 0 %}bg-danger{% elif session_data_for_modal_dict.places_restantes <= 3 %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                            {{ session_data_for_modal_dict.places_restantes }} / {{ session_obj_for_modal.max_participants }}
                                        </strong>
                                    </p>
                                    <p class="mb-0 small text-body-secondary">
                                        <i class="fas fa-building fa-fw me-1"></i>Salle: 
                                        <span class="badge bg-light text-dark border">{{ session_obj_for_modal.salle.nom if session_obj_for_modal.salle else "Non définie" }}</span>
                                    </p>
                                </div>
                            </div>
                            </div>

                            <!-- Navigation par onglets -->
                            <ul class="nav nav-pills nav-fill mb-3" id="inscriptionTabs_{{ session_obj_for_modal.id }}" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="participant-existant-tab_{{ session_obj_for_modal.id }}" data-bs-toggle="tab" data-bs-target="#participant-existant_{{ session_obj_for_modal.id }}" type="button" role="tab" aria-controls="participant-existant_{{ session_obj_for_modal.id }}" aria-selected="true">
                                <i class="fas fa-user me-1"></i> Participant existant
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="nouveau-participant-tab_{{ session_obj_for_modal.id }}" data-bs-toggle="tab" data-bs-target="#nouveau-participant_{{ session_obj_for_modal.id }}" type="button" role="tab" aria-controls="nouveau-participant_{{ session_obj_for_modal.id }}" aria-selected="false">
                                <i class="fas fa-user-plus me-1"></i> Nouveau participant
                                </button>
                            </li>
                            </ul>

                            <!-- Contenu des onglets -->
                            <div class="tab-content pt-3" id="inscriptionTabsContent_{{ session_obj_for_modal.id }}">
                            
                            <!-- Onglet participant existant -->
                            <div class="tab-pane fade show active" id="participant-existant_{{ session_obj_for_modal.id }}" role="tabpanel" aria-labelledby="participant-existant-tab_{{ session_obj_for_modal.id }}">
                                <form action="{{ url_for('inscription') }}" method="post" id="inscription-form-{{ session_obj_for_modal.id }}" class="needs-validation" novalidate>
                                <input type="hidden" name="session_id" value="{{ session_obj_for_modal.id }}">
                                <input type="hidden" name="from_page" value="{{ request.endpoint or 'dashboard' }}">
                                
                                <div class="mb-3">
                                    <label for="participant_id_{{ session_obj_for_modal.id }}" class="form-label">Sélectionner un participant*</label>
                                    <select class="form-select form-select-lg" id="participant_id_{{ session_obj_for_modal.id }}" name="participant_id" required>
                                    <option value="" selected disabled>-- Choisir dans la liste --</option>
                                    {% for participant in participants|sort(attribute='prenom')|sort(attribute='nom') %} 
                                    <option value="{{ participant.id }}">{{ participant.prenom }} {{ participant.nom }} ({{ participant.service.nom }})</option>
                                    {% endfor %}
                                    </select>
                                    <div class="invalid-feedback">
                                    Veuillez sélectionner un participant.
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-check-circle me-2"></i>Confirmer l'inscription
                                    </button>
                                </div>
                                </form>
                            </div>
                            
                            <!-- Onglet nouveau participant -->
                            <div class="tab-pane fade" id="nouveau-participant_{{ session_obj_for_modal.id }}" role="tabpanel" aria-labelledby="nouveau-participant-tab_{{ session_obj_for_modal.id }}">
                                <p class="small text-muted mb-3">Ajoutez un nouveau participant. Il sera automatiquement inscrit à cette session (en attente de validation par son responsable ou un admin).</p>
                                <form action="{{ url_for('add_participant') }}" method="post" id="new-participant-form-{{ session_obj_for_modal.id }}" class="needs-validation" novalidate>
                                <input type="hidden" name="from_page" value="{{ request.endpoint or 'dashboard' }}"> 
                                <input type="hidden" name="redirect_session_id" value="{{ session_obj_for_modal.id }}">
                                <input type="hidden" name="action_after_add" value="inscription">
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                    <label for="nom_nouveau_{{ session_obj_for_modal.id }}" class="form-label">Nom*</label>
                                    <input type="text" class="form-control" id="nom_nouveau_{{ session_obj_for_modal.id }}" name="nom" required>
                                    <div class="invalid-feedback">Le nom est obligatoire.</div>
                                    </div>
                                    <div class="col-md-6">
                                    <label for="prenom_nouveau_{{ session_obj_for_modal.id }}" class="form-label">Prénom*</label>
                                    <input type="text" class="form-control" id="prenom_nouveau_{{ session_obj_for_modal.id }}" name="prenom" required>
                                    <div class="invalid-feedback">Le prénom est obligatoire.</div>
                                    </div>
                                    <div class="col-12">
                                    <label for="email_nouveau_{{ session_obj_for_modal.id }}" class="form-label">Email*</label>
                                    <input type="email" class="form-control" id="email_nouveau_{{ session_obj_for_modal.id }}" name="email" required>
                                    <div class="invalid-feedback">Une adresse email valide est obligatoire.</div>
                                    </div>
                                    <div class="col-12">
                                    <label for="service_id_nouveau_{{ session_obj_for_modal.id }}" class="form-label">Service*</label>
                                    <select class="form-select" id="service_id_nouveau_{{ session_obj_for_modal.id }}" name="service_id" required>
                                        <option value="" selected disabled>-- Choisir un service --</option>
                                        {% for service_item in services|sort(attribute='nom') %}
                                        <option value="{{ service_item.id }}">{{ service_item.nom }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback">Le service est obligatoire.</div>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 mt-4">
                                    <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-user-plus me-2"></i>Ajouter et Inscrire
                                    </button>
                                </div>
                                </form>
                            </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer bg-light justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i> Annuler
                            </button>
                            {% if session_data_for_modal_dict.places_restantes == 0 %}
                            <a href="{{ url_for('liste_attente', session_id=session_obj_for_modal.id) }}" class="btn btn-warning">
                            <i class="fas fa-clock me-1"></i> S'inscrire en liste d'attente
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {# Modal Participants #}
            <div class="modal fade modal-fix" id="participantsModal_{{ session_obj_for_modal.id }}" tabindex="-1" aria-labelledby="participantsModalLabel_{{ session_obj_for_modal.id }}" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                    <!-- En-tête du modal -->
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title" id="participantsModalLabel_{{ session_obj_for_modal.id }}">
                        <i class="fas fa-users me-2"></i>Participants: {{ session_obj_for_modal.theme.nom }}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
                    </div>
                    
                    <!-- Corps du modal -->
                    <div class="modal-body">
                        <!-- Informations session -->
                        <div class="alert alert-light border mb-4">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <h6 class="mb-1 fw-bold text-info me-3">Session du {{ session_obj_for_modal.formatage_date }} ({{ session_obj_for_modal.formatage_horaire }})</h6>
                            <span class="badge {% if session_data_for_modal_dict.places_restantes|default(session_obj_for_modal.max_participants) == 0 %}bg-danger{% elif session_data_for_modal_dict.places_restantes|default(session_obj_for_modal.max_participants) <= 3 %}bg-warning text-dark{% else %}bg-success{% endif %}">
                            {{ session_data_for_modal_dict.places_restantes|default(0) }} / {{ session_obj_for_modal.max_participants|default(0) }} places dispo.
                            </span>
                        </div>
                        <hr class="my-2">
                        <p class="mb-0 small text-muted">
                            <i class="fas fa-building fa-fw me-1"></i><strong>Salle:</strong> 
                            <span class="badge bg-light text-dark border">{{ session_obj_for_modal.salle.nom if session_obj_for_modal.salle else "Non définie" }}</span>
                        </p>
                        </div>

                        <!-- Navigation par onglets simplifiée -->
                        <ul class="nav nav-tabs" id="participantsTabs_{{ session_obj_for_modal.id }}" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="confirmes-tab-{{ session_obj_for_modal.id }}" data-bs-toggle="tab" href="#confirmes-{{ session_obj_for_modal.id }}" role="tab" aria-selected="true">
                            <i class="fas fa-check-circle text-success me-1"></i> Confirmés 
                            <span class="badge bg-success">{{ session_data_for_modal_dict.inscrits_confirmes_count|default(0) }}</span>
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="en-attente-tab-{{ session_obj_for_modal.id }}" data-bs-toggle="tab" href="#en-attente-{{ session_obj_for_modal.id }}" role="tab" aria-selected="false">
                            <i class="fas fa-clock text-warning me-1"></i> En attente 
                            <span class="badge bg-warning text-dark">{{ session_data_for_modal_dict.pending_count|default(0) }}</span>
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="liste-attente-tab-{{ session_obj_for_modal.id }}" data-bs-toggle="tab" href="#liste-attente-{{ session_obj_for_modal.id }}" role="tab" aria-selected="false">
                            <i class="fas fa-hourglass-half text-info me-1"></i> Liste d'attente 
                            <span class="badge bg-info text-dark">{{ session_data_for_modal_dict.liste_attente_count|default(0) }}</span>
                            </a>
                        </li>
                        </ul>

                        <!-- Contenu des onglets -->
                        <div class="tab-content py-3" id="participantsTabsContent_{{ session_obj_for_modal.id }}">
                        
                        <!-- Tab 1: Participants confirmés -->
                        <div class="tab-pane fade show active" id="confirmes-{{ session_obj_for_modal.id }}" role="tabpanel">
                            {% set inscrits_list = session_data_for_modal_dict.loaded_inscrits_confirmes %}
                            {% if inscrits_list and inscrits_list|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                <thead>
                                    <tr>
                                    <th>Participant</th>
                                    <th>Service</th>
                                    <th>Date Inscription</th>
                                    <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for inscription in inscrits_list %}
                                    <tr>
                                        <td>{{ inscription.participant.prenom|escape }} {{ inscription.participant.nom|escape }}</td>
                                        <td>
                                        <span class="badge" style="background-color: {{ inscription.participant.service.couleur|default('#6c757d') }};">
                                            {{ inscription.participant.service.nom|escape }}
                                        </span>
                                        </td>
                                        <td>{{ inscription.date_inscription.strftime('%d/%m/%Y %H:%M') }}</td>
                                        <td class="text-center">
                                        <div class="btn-group">
                                            <a href="{{ url_for('generer_invitation', inscription_id=inscription.id) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="far fa-calendar-plus"></i>
                                            </a>
                                            {% if current_user.is_authenticated and current_user.role == 'admin' %}
                                            <form action="{{ url_for('validation_inscription', inscription_id=inscription.id) }}" method="post" class="d-inline">
                                            <input type="hidden" name="action" value="annuler">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Êtes-vous sûr de vouloir annuler cette inscription ?');">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                            </form>
                                            {% endif %}
                                        </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-light text-center py-4">
                                <i class="fas fa-info-circle fa-2x text-muted mb-3 d-block"></i>
                                <p class="mb-0">Aucun participant confirmé pour cette session.</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Tab 2: Participants en attente -->
                        <div class="tab-pane fade" id="en-attente-{{ session_obj_for_modal.id }}" role="tabpanel">
                            {% set pending_list = session_data_for_modal_dict.loaded_pending_inscriptions %}
                            {% if pending_list and pending_list|length > 0 %}
                            <div class="alert alert-warning small mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Ces inscriptions sont en attente de validation par un responsable ou un administrateur.
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                <thead>
                                    <tr>
                                    <th>Participant</th>
                                    <th>Service</th>
                                    <th>Date Demande</th>
                                    <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for inscription in pending_list %}
                                    <tr>
                                        <td>{{ inscription.participant.prenom|escape }} {{ inscription.participant.nom|escape }}</td>
                                        <td>
                                        <span class="badge" style="background-color: {{ inscription.participant.service.couleur|default('#6c757d') }};">
                                            {{ inscription.participant.service.nom|escape }}
                                        </span>
                                        </td>
                                        <td>{{ inscription.date_inscription.strftime('%d/%m/%Y %H:%M') }}</td>
                                        <td class="text-center">
                                        {% if current_user.is_authenticated and (current_user.role == 'admin' or (current_user.role == 'responsable' and current_user.service_id == inscription.participant.service_id)) %}
                                            <div class="btn-group">
                                            <form action="{{ url_for('validation_inscription', inscription_id=inscription.id) }}" method="post" class="d-inline">
                                                <input type="hidden" name="action" value="valider">
                                                <button type="submit" class="btn btn-sm btn-success" {{ 'disabled' if session_data_for_modal_dict.places_restantes|default(0) <= 0 else '' }}>
                                                <i class="fas fa-check"></i> Valider
                                                </button>
                                            </form>
                                            <form action="{{ url_for('validation_inscription', inscription_id=inscription.id) }}" method="post" class="d-inline ms-1">
                                                <input type="hidden" name="action" value="refuser">
                                                <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-times"></i> Refuser
                                                </button>
                                            </form>
                                            </div>
                                        {% else %}
                                            <span class="badge bg-light text-dark border">Validation requise</span>
                                        {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-light text-center py-4">
                                <i class="fas fa-info-circle fa-2x text-muted mb-3 d-block"></i>
                                <p class="mb-0">Aucune inscription en attente de validation pour cette session.</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Tab 3: Liste d'attente -->
                        <div class="tab-pane fade" id="liste-attente-{{ session_obj_for_modal.id }}" role="tabpanel">
                            {% set waitlist_list = session_data_for_modal_dict.loaded_liste_attente %}
                            {% if waitlist_list and waitlist_list|length > 0 %}
                            <div class="alert alert-info small mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Participants en liste d'attente car la session est/était complète.
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                <thead>
                                    <tr>
                                    <th class="text-center">Pos.</th>
                                    <th>Participant</th>
                                    <th>Service</th>
                                    <th>Date Inscription</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attente in waitlist_list %}
                                    <tr>
                                        <td class="text-center"><span class="badge bg-secondary">{{ attente.position }}</span></td>
                                        <td>{{ attente.participant.prenom|escape }} {{ attente.participant.nom|escape }}</td>
                                        <td>
                                        <span class="badge" style="background-color: {{ attente.participant.service.couleur|default('#6c757d') }};">
                                            {{ attente.participant.service.nom|escape }}
                                        </span>
                                        </td>
                                        <td>{{ attente.date_inscription.strftime('%d/%m/%Y %H:%M') }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-light text-center py-4">
                                <i class="fas fa-info-circle fa-2x text-muted mb-3 d-block"></i>
                                <p class="mb-0">Aucun participant en liste d'attente pour cette session.</p>
                            </div>
                            {% endif %}
                        </div>
                        </div>
                    </div>
                    
                    <!-- Pied du modal -->
                    <div class="modal-footer bg-light justify-content-between">
                        <div>
                        {% if session_data_for_modal_dict.places_restantes|default(0) > 0 %}
                            <button type="button" class="btn btn-primary"
                                    onclick="showInscriptionModalTransition('{{ session_obj_for_modal.id }}')">
                            <i class="fas fa-user-plus me-1"></i> Inscrire un participant
                            </button>
                        {% elif current_user.is_authenticated %}
                            <a href="{{ url_for('liste_attente', session_id=session_obj_for_modal.id) }}" 
                            class="btn btn-warning">
                            <i class="fas fa-clock me-1"></i> Liste d'attente
                            </a>
                        {% else %}
                            <span class="text-muted">Session complète.</span>
                        {% endif %}
                        </div>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Fermer
                        </button>
                    </div>
                    </div>
                </div>
            </div>

            {# Modal Attribuer Salle (Admin) #}
            {% if current_user.is_authenticated and current_user.role == 'admin' %}
                <div class="modal fade modal-fix" id="attribuerSalleModal_{{ session_obj_for_modal.id }}" tabindex="-1" aria-labelledby="attribuerSalleModalLabel_{{ session_obj_for_modal.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-secondary text-white">
                                <h5 class="modal-title" id="attribuerSalleModalLabel_{{ session_obj_for_modal.id }}">
                                    <i class="fas fa-door-open me-2"></i>Attribuer une Salle
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p class="mb-3">Session du <strong>{{ session_obj_for_modal.formatage_date }}</strong> à <strong>{{ session_obj_for_modal.formatage_horaire }}</strong>.</p>
                                
                                <form action="{{ url_for('attribuer_salle', session_id=session_obj_for_modal.id) }}" method="post" class="needs-validation" novalidate>
                                    <div class="mb-3">
                                        <label for="salle_id_{{ session_obj_for_modal.id }}" class="form-label">Salle*</label>
                                        <select class="form-select" id="salle_id_{{ session_obj_for_modal.id }}" name="salle_id" required>
                                            <option value="" disabled {% if not session_obj_for_modal.salle %}selected{% endif %}>Sélectionner une salle</option>
                                            {% for salle in salles %}
                                                <option value="{{ salle.id }}" {% if session_obj_for_modal.salle and session_obj_for_modal.salle.id == salle.id %}selected{% endif %}>
                                                    {{ salle.nom }} ({{ salle.capacite }} places)
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">
                                            Veuillez sélectionner une salle.
                                        </div>
                                        <div class="form-text">
                                            Note: La capacité de la salle devrait être suffisante pour accueillir le nombre d'inscrits.
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between mt-4">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-save me-1"></i>Enregistrer
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
    
    {# Modal global pour ajouter un participant (si utilisé depuis le dashboard) #}
    {% if current_user.is_authenticated and (current_user.role == 'admin' or current_user.role == 'responsable') %}
        <div class="modal fade modal-fix" id="addParticipantModalGlobal" tabindex="-1" aria-labelledby="addParticipantModalGlobalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="addParticipantModalGlobalLabel"><i class="fas fa-user-plus me-2"></i>Ajouter un Nouveau Participant</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form action="{{ url_for('add_participant') }}" method="post" class="needs-validation" novalidate>
                            <input type="hidden" name="from_page" value="participants_page">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="add_nom_global" class="form-label">Nom*</label>
                                    <input type="text" class="form-control" id="add_nom_global" name="nom" required>
                                    <div class="invalid-feedback">Le nom est requis.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="add_prenom_global" class="form-label">Prénom*</label>
                                    <input type="text" class="form-control" id="add_prenom_global" name="prenom" required>
                                    <div class="invalid-feedback">Le prénom est requis.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="add_email_global" class="form-label">Email*</label>
                                    <input type="email" class="form-control" id="add_email_global" name="email" required>
                                    <div class="invalid-feedback">Un email valide est requis.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="add_service_id_global" class="form-label">Service*</label>
                                    <select class="form-select" id="add_service_id_global" name="service_id" required>
                                        <option value="" disabled selected>-- Choisir un service --</option>
                                        {% for service in services|sort(attribute='nom') %} 
                                        <option value="{{ service.id }}">{{ service.nom }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback">Le service est requis.</div>
                                </div>
                            </div>
                            <div class="d-grid mt-4">
                                <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-plus-circle me-2"></i>Ajouter le Participant</button>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block scripts_extra %}
<script>
    window.themesDataForChart = {{ themes_config|tojson|safe }};
    window.servicesDataForChart = {{ services_config|tojson|safe }};
    if (typeof window.themesDataForChart !== 'object' || window.themesDataForChart === null) { console.warn("themesDataForChart n'est pas un objet valide"); window.themesDataForChart = {}; }
    if (typeof window.servicesDataForChart !== 'object' || window.servicesDataForChart === null) { console.warn("servicesDataForChart n'est pas un objet valide"); window.servicesDataForChart = {}; }

    document.addEventListener('DOMContentLoaded', function() {
        // Fonction pour afficher la modale d'inscription après avoir fermé la modale de participants
        window.showInscriptionModalTransition = function(sessionId) {
            const debugMode = window.dashboardConfig && window.dashboardConfig.debugMode;
            if (debugMode) console.log(`ModalTransition: Attempting to show inscriptionModal_${sessionId} from participantsModal_${sessionId}`);

            const participantsModalElement = document.getElementById(`participantsModal_${sessionId}`);
            const inscriptionModalElement = document.getElementById(`inscriptionModal_${sessionId}`);

            if (!participantsModalElement || !inscriptionModalElement) {
                console.error("ModalTransition: Critical Error - One or both modals not found in DOM for transition.");
                if (typeof window.showToast === 'function') {
                    window.showToast("Erreur: Impossible d'ouvrir le formulaire d'inscription.", "danger");
                }
                return;
            }

            let bsParticipantsModal = bootstrap.Modal.getInstance(participantsModalElement);
            if (!bsParticipantsModal) {
                if (debugMode) console.warn(`ModalTransition: Participants modal ${sessionId} instance not found, creating new.`);
                bsParticipantsModal = new bootstrap.Modal(participantsModalElement);
            }

            let bsInscriptionModal = bootstrap.Modal.getInstance(inscriptionModalElement);
            if (!bsInscriptionModal) {
                if (debugMode) console.warn(`ModalTransition: Inscription modal ${sessionId} instance not found, creating new.`);
                bsInscriptionModal = new bootstrap.Modal(inscriptionModalElement);
            }
            
            participantsModalElement.addEventListener('hidden.bs.modal', function onParticipantsModalHidden() {
                if (debugMode) console.log(`ModalTransition: participantsModal_${sessionId} is now hidden. Preparing to show inscriptionModal_${sessionId}.`);
                
                // Léger délai pour s'assurer que le DOM est stable et que Bootstrap a nettoyé
                setTimeout(() => {
                    bsInscriptionModal.show();
                    if (debugMode) console.log(`ModalTransition: inscriptionModal_${sessionId} show() command issued.`);
                }, 50); // Un délai très court, 50ms est souvent suffisant.
                
            }, { once: true });

            bsParticipantsModal.hide();
            if (debugMode) console.log(`ModalTransition: participantsModal_${sessionId} hide() command issued.`);
        };

        // Ajouter une fonction pour initialiser les formulaires modaux
        function initializeModalForms() {
            document.querySelectorAll('.modal form.needs-validation').forEach(form => {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                });
            });
        }

        // Ajouter une fonction pour initialiser les modaux
        function initializeModals() {
            document.querySelectorAll('.modal').forEach(modalElement => {
                // Ajouter la classe modal-fix pour les correctifs CSS
                modalElement.classList.add('modal-fix');
                
                // Gérer l'événement d'affichage pour appliquer les correctifs spécifiques
                modalElement.addEventListener('shown.bs.modal', function() {
                    // Assurer la visibilité des éléments de formulaire
                    const formElements = this.querySelectorAll('input, select, textarea, .form-select, .form-control, button:not(.btn-close)');
                    formElements.forEach(el => {
                        el.style.display = 'block';
                        el.style.visibility = 'visible';
                        el.style.opacity = '1';
                        el.style.position = 'relative';
                        el.style.zIndex = '1060';
                        
                        // Si c'est un select, assurer qu'il est visible et utilisable
                        if (el.tagName === 'SELECT' || el.classList.contains('form-select')) {
                            el.style.appearance = 'menulist';
                            el.style.webkitAppearance = 'menulist';
                            el.style.mozAppearance = 'menulist';
                        }
                        
                        // Pour les boutons, garder le display inline-block
                        if (el.tagName === 'BUTTON' || el.classList.contains('btn')) {
                            el.style.display = 'inline-block';
                        }
                    });
                    
                    // Assurer que les onglets fonctionnent
                    const tabPanes = this.querySelectorAll('.tab-pane');
                    tabPanes.forEach(pane => {
                        if (pane.classList.contains('active')) {
                            pane.style.display = 'block';
                            pane.style.visibility = 'visible';
                            pane.style.opacity = '1';
                        } else {
                            pane.style.display = 'none';
                        }
                    });
                    
                    // Focus sur le premier champ du formulaire après affichage
                    setTimeout(() => {
                        const firstField = this.querySelector('select, input:not([type="hidden"]), textarea, button:not([type="hidden"]):not(.btn-close)');
                        if (firstField) {
                            try {
                                firstField.focus();
                            } catch (e) {
                                console.warn("Couldn't focus first field in modal", e);
                            }
                        }
                    }, 100);
                });
                
                // Gérer correctement les validations AJAX
                const ajaxButtons = modalElement.querySelectorAll('.validation-ajax');
                ajaxButtons.forEach(button => {
                    if (button.dataset.ajaxListenerAttached === 'true') return;
                    button.dataset.ajaxListenerAttached = 'true';
                    
                    button.addEventListener('click', function() {
                        this.disabled = true;
                        const originalHTML = this.innerHTML;
                        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                        
                        const inscriptionId = this.getAttribute('data-inscription-id');
                        const action = this.getAttribute('data-action');
                        
                        fetch('/validation_inscription_ajax', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                inscription_id: inscriptionId,
                                action: action
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                if (typeof window.showToast === 'function') window.showToast(data.message, 'success');
                                setTimeout(() => {
                                    // Rafraîchir les données et fermer le modal
                                    if (typeof window.forcePollingUpdate === 'function') {
                                        window.forcePollingUpdate(true);
                                    } else {
                                        window.location.reload();
                                    }
                                    const modal = bootstrap.Modal.getInstance(modalElement);
                                    if (modal) modal.hide();
                                }, 1000);
                            } else {
                                if (typeof window.showToast === 'function') window.showToast(data.message || 'Erreur.', 'danger');
                                this.disabled = false;
                                this.innerHTML = originalHTML;
                            }
                        })
                        .catch(error => {
                            console.error('Erreur AJAX validation:', error);
                            if (typeof window.showToast === 'function') window.showToast(error.message || 'Erreur serveur.', 'danger');
                            this.disabled = false;
                            this.innerHTML = originalHTML;
                        });
                    });
                });
            });
        }

        // Initialiser les tooltips
        if (typeof bootstrap !== 'undefined' && typeof bootstrap.Tooltip === 'function') {
            const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltips.forEach(function (tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Améliorer les badges de thème
        if (typeof window.enhanceThemeBadgesGlobally === 'function') { 
            window.enhanceThemeBadgesGlobally(); 
        }
        
        // Initialiser les modaux et les formulaires
        initializeModals();
        initializeModalForms();
    });

    // Fonction pour afficher des toasts de notification
    window.showToast = function(message, type = 'info') {
        if (typeof bootstrap === 'undefined' || !bootstrap.Toast) {
            alert(message);
            return;
        }
        
        // Créer le conteneur de toast s'il n'existe pas
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Créer l'élément toast
        const toastElement = document.createElement('div');
        toastElement.className = `toast bg-${type} text-white fade`;
        toastElement.setAttribute('role', 'alert');
        toastElement.setAttribute('aria-live', 'assertive');
        toastElement.setAttribute('aria-atomic', 'true');
        
        // Contenu du toast
        toastElement.innerHTML = `
            <div class="toast-header bg-${type} text-white">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'danger' ? 'fa-exclamation-circle' : 'fa-info-circle'} me-2"></i>
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        // Ajouter au conteneur
        toastContainer.appendChild(toastElement);
        
        // Initialiser et afficher le toast
        const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
        toast.show();
        
        // Supprimer l'élément une fois caché
        toastElement.addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    };
</script>
{% endblock %}
