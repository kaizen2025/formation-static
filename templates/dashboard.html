{% extends "layout.html" %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold text-primary mb-0"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h1>
            <p class="text-muted">Vue d'ensemble des formations Microsoft 365</p>
        </div>
        <div>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" id="refresh-dashboard">
                    <i class="fas fa-sync-alt me-2"></i>Actualiser
                </button>
                {% if current_user.is_authenticated and current_user.role == 'admin' %}
                <a href="{{ url_for('salles') }}" class="btn btn-outline-primary">
                    <i class="fas fa-building me-2"></i>Gérer les salles
                </a>
                 <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary"> <!-- Link to Admin Panel -->
                    <i class="fas fa-cogs me-2"></i>Admin Panel
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Cartes statistiques -->
    <div class="row mb-4">
         <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-primary h-100 py-2 shadow-sm stats-card">
                <div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-primary text-uppercase mb-1 title">Sessions programmées</div><div class="h5 mb-0 font-weight-bold text-gray-800 counter-value value" id="sessions_programmees">{{ sessions_data|length|default(0) }}</div></div><div class="col-auto"><i class="fas fa-calendar-alt fa-2x text-primary-light icon"></i></div></div></div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-success h-100 py-2 shadow-sm stats-card">
                <div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-success text-uppercase mb-1 title">Participants inscrits (Conf.)</div><div class="h5 mb-0 font-weight-bold text-gray-800 counter-value value" id="total_inscriptions">{{ total_inscriptions|default(0) }}</div></div><div class="col-auto"><i class="fas fa-users fa-2x text-success-light icon"></i></div></div></div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-warning h-100 py-2 shadow-sm stats-card">
                <div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-warning text-uppercase mb-1 title">En liste d'attente (Total)</div><div class="h5 mb-0 font-weight-bold text-gray-800 counter-value value" id="total_en_attente">{{ total_en_attente|default(0) }}</div></div><div class="col-auto"><i class="fas fa-user-clock fa-2x text-warning-light icon"></i></div></div></div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-danger h-100 py-2 shadow-sm stats-card">
                <div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-danger text-uppercase mb-1 title">Sessions complètes</div><div class="h5 mb-0 font-weight-bold text-gray-800 counter-value value" id="total_sessions_completes">{{ total_sessions_completes|default(0) }}</div></div><div class="col-auto"><i class="fas fa-ban fa-2x text-danger-light icon"></i></div></div></div>
            </div>
        </div>
    </div>

    <!-- Interface principale de contenu -->
    <div class="row">
        <!-- Sessions à venir -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-calendar-check me-2"></i>Sessions à venir</h6>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="sessionsFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-filter me-1"></i>Filtrer
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sessionsFilterDropdown">
                             <li><h6 class="dropdown-header">Statut</h6></li>
                            <li><a class="dropdown-item filter-link" href="#" data-filter="all">Toutes les sessions</a></li>
                            <li><a class="dropdown-item filter-link" href="#" data-filter="available">Places disponibles</a></li>
                            <li><a class="dropdown-item filter-link" href="#" data-filter="full">Sessions complètes</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Thème</h6></li>
                            <li><a class="dropdown-item filter-link" href="#" data-filter="communiquer-avec-teams">Communiquer avec Teams</a></li>
                            <li><a class="dropdown-item filter-link" href="#" data-filter="gerer-les-taches-planner">Gérer les tâches (Planner)</a></li>
                            <li><a class="dropdown-item filter-link" href="#" data-filter="gerer-mes-fichiers-onedrive/sharepoint">Gérer mes fichiers (OneDrive/SharePoint)</a></li>
                            <li><a class="dropdown-item filter-link" href="#" data-filter="collaborer-avec-teams">Collaborer avec Teams</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body px-0 pb-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="sessions-table">
                            <thead class="table-light">
                                <tr>
                                    <th class="px-3">Date / Horaire</th>
                                    <th>Thème</th>
                                    <th class="text-center">Places</th>
                                    <th class="text-center">Inscrits / Attente</th>
                                    <th class="text-center">Salle</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if sessions_data %}
                                {% for item in sessions_data %}
                                {% set session = item.obj %}
                                {% set inscrits_confirmes_count = item.inscrits_confirmes_count %}
                                {% set liste_attente_count = item.liste_attente_count %}
                                {% set places_restantes = item.places_restantes %}
                                {% set progress = (inscrits_confirmes_count / session.max_participants * 100) if session.max_participants > 0 else 0 %}
                                <tr class="session-row align-middle" data-session-id="{{ session.id }}" data-theme="{{ session.theme.nom|replace('(', '')|replace(')', '')|replace('/', '-')|replace(' ', '-')|lower }}" data-full="{{ 1 if places_restantes == 0 else 0 }}">
                                     <td class="px-3"><div class="fw-bold">{{ session.formatage_date }}</div><small class="text-muted">{{ session.formatage_horaire }}</small></td>
                                    <td><span class="badge theme-badge {% if session.theme.nom == 'Communiquer avec Teams' %}theme-comm{% elif session.theme.nom == 'Gérer les tâches (Planner)' %}theme-planner{% elif session.theme.nom == 'Gérer mes fichiers (OneDrive/SharePoint)' %}theme-onedrive{% elif session.theme.nom == 'Collaborer avec Teams' %}theme-sharepoint{% endif %}">{{ session.theme.nom }}</span></td>
                                    <td class="text-center"><span class="fw-bold places-dispo {% if places_restantes <= 3 %}text-danger{% elif places_restantes <= 7 %}text-warning{% else %}text-success{% endif %}" data-session-id="{{ session.id }}" data-max-participants="{{ session.max_participants }}">{{ places_restantes|default(0) }}</span><span class="text-muted">/ {{ session.max_participants|default(15) }}</span><div class="progress mt-1" style="height: 5px;"><div class="progress-bar progress-bar-striped {% if places_restantes == 0 %}bg-danger{% elif progress >= 75 %}bg-warning{% else %}bg-success{% endif %}" role="progressbar" style="width: {{ progress }}%;" aria-valuenow="{{ inscrits_confirmes_count }}" aria-valuemin="0" aria-valuemax="{{ session.max_participants }}" data-session-id="{{ session.id }}" data-max-participants="{{ session.max_participants }}"></div></div></td>
                                    <td class="text-center"><button type="button" class="btn btn-sm btn-outline-primary position-relative btn-view-participants" data-bs-toggle="modal" data-bs-target="#participantsModal{{ session.id }}" title="Voir les inscrits"><i class="fas fa-users me-1"></i><span class="inscrits-count" data-session-id="{{ session.id }}">{{ inscrits_confirmes_count }}</span></button>{% if liste_attente_count > 0 %}<button type="button" class="btn btn-sm btn-outline-warning position-relative ms-1 btn-view-attente" data-bs-toggle="modal" data-bs-target="#participantsModal{{ session.id }}" data-show-tab="attente" title="Voir la liste d'attente"><i class="fas fa-user-clock me-1"></i><span class="attente-counter" data-session-id="{{ session.id }}">{{ liste_attente_count }}<span class="visually-hidden">en attente</span></span></button>{% endif %}</td>
                                    <td class="text-center">{% if session.salle %}<span class="badge bg-info text-dark salle-badge" data-session-id="{{ session.id }}" title="{{ session.salle.lieu or ''}}">{{ session.salle.nom }}</span>{% else %}<span class="badge bg-secondary salle-badge" data-session-id="{{ session.id }}">Non définie</span>{% endif %}</td>
                                    <td class="text-center"><div class="btn-group">{% if places_restantes > 0 %}<button type="button" class="btn btn-sm btn-primary btn-action-inscription" data-bs-toggle="modal" data-bs-target="#inscriptionModal{{ session.id }}" title="Inscrire"><i class="fas fa-user-plus"></i></button>{% else %}<button type="button" class="btn btn-sm btn-warning btn-action-attente" data-bs-toggle="modal" data-bs-target="#inscriptionModal{{ session.id }}" data-go-to-attente="true" title="Ajouter à la liste d'attente"><i class="fas fa-clock"></i></button>{% endif %}{% if current_user.is_authenticated and current_user.role == 'admin' %}<button type="button" class="btn btn-sm btn-outline-secondary btn-action-salle" data-bs-toggle="modal" data-bs-target="#attribuerSalleModal{{ session.id }}" title="Attribuer une salle"><i class="fas fa-building"></i></button>{% endif %}</div></td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr><td colspan="6" class="text-center text-muted p-4">Aucune session programmée pour le moment.</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>
        </div>

        <!-- Graphiques et Activité -->
        <div class="col-lg-4">
            <!-- Graphique par thème -->
            <div class="card shadow-sm mb-4"><div class="card-header bg-white py-3"><h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-chart-pie me-2"></i>Répartition par thème (Inscrits)</h6></div><div class="card-body"><div class="chart-container" style="min-height: 250px;"><canvas id="themeChart" width="100%" height="100"></canvas><div class="chart-overlay justify-content-center align-items-center d-flex" id="theme-chart-overlay"><div class="text-center"><div class="spinner-border text-primary mb-2" role="status"><span class="visually-hidden">Chargement...</span></div><p class="text-muted mb-0">Chargement...</p></div></div></div></div></div>
            <!-- Graphique par service -->
            <div class="card shadow-sm mb-4"><div class="card-header bg-white py-3"><h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-chart-bar me-2"></i>Participants par service</h6></div><div class="card-body"><div class="chart-container" style="min-height: 250px;"><canvas id="serviceChart" width="100%" height="100"></canvas><div class="chart-overlay justify-content-center align-items-center d-flex" id="service-chart-overlay"><div class="text-center"><div class="spinner-border text-primary mb-2" role="status"><span class="visually-hidden">Chargement...</span></div><p class="text-muted mb-0">Chargement...</p></div></div></div></div></div>
            <!-- Activité récente -->
            <div class="card shadow-sm mb-4"><div class="card-header bg-white py-3"><h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-history me-2"></i>Activité récente</h6></div><div class="card-body p-0" style="max-height: 300px; overflow-y: auto;"><div class="list-group list-group-flush" id="recent-activity"><div class="list-group-item p-4 text-center text-muted"><div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div> Chargement...</div></div></div><div class="card-footer bg-white py-2 text-center"><a href="{{ url_for('activites') }}" class="text-primary small">Voir toutes les activités <i class="fas fa-arrow-right ms-1"></i></a></div></div>
        </div>
    </div>
</div>

<!-- MODALS -->
{% if sessions_data is defined and sessions_data %}
    {% for item in sessions_data %}
        {% set session = item.obj %}
        {# Passer les variables spécifiques nécessaires #}
        {% with %}
            {% set session = session %}
            {% set places_restantes = item.places_restantes %}
            {% set participants = participants %}
            {% set services = services %}
            {% include 'modals/_inscription_modal.html' %}
        {% endwith %}
        
        {% with %}
            {% set session = session %}
            {% set count_confirmed = item.inscrits_confirmes_count %}
            {% set count_pending = item.pending_count %}
            {% set count_waitlist = item.liste_attente_count %}
            {% include 'modals/_participants_modal.html' %}
        {% endwith %}
        
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
            {% with %}
                {% set session = session %}
                {% set salles = salles %}
                {% include 'modals/_attribuer_salle_modal.html' %}
            {% endwith %}
        {% endif %}
    {% endfor %}
{% endif %}

{% endblock %}

{% block scripts %}
{{ super() }} <!-- Include scripts from layout.html -->
{# ***** JS COMPLET POUR DASHBOARD ***** #}
<script>
    // Variable globale de configuration JS (peut être utilisée par websocket.js)
    window.config = {
        debugMode: false // Mettre à true pour plus de logs console
    };

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Dashboard JS loaded');
        const config = window.config; // Utiliser la config globale

        // --- Dashboard Specific Initializations ---

        // 1. Filter Logic
        const filterLinks = document.querySelectorAll('.filter-link');
        const sessionsTableBody = document.querySelector('#sessions-table tbody');
        const filterDropdownButton = document.getElementById('sessionsFilterDropdown');
        if(filterLinks.length > 0 && sessionsTableBody && filterDropdownButton) {
            filterLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const filter = this.dataset.filter;
                    const rows = sessionsTableBody.querySelectorAll('.session-row');
                    if (config.debugMode) console.log(`Filtering by: ${filter}`);
                    rows.forEach(row => {
                        let show = false;
                        if (filter === 'all') { show = true; }
                        else if (filter === 'available') { show = row.dataset.full === '0'; }
                        else if (filter === 'full') { show = row.dataset.full === '1'; }
                        else { show = row.dataset.theme === filter; }
                        row.style.display = show ? '' : 'none';
                    });
                    filterDropdownButton.innerHTML = `<i class="fas fa-filter me-1"></i>${this.textContent}`;
                });
            });
        } else {
             console.warn("Filter elements not found for dashboard table.");
        }

        // 2. Counter Animation (Utilise la fonction globale de websocket.js)
         function animateAllDashboardCounters() {
            const counterElements = document.querySelectorAll('.counter-value');
             counterElements.forEach(counter => {
                 const target = parseInt(counter.textContent.replace(/,/g, ''), 10) || 0;
                 if (typeof animateCounter === 'function') { // Vérifie si la fonction globale existe
                    const current = parseInt(counter.dataset.currentValue || '0', 10);
                     animateCounter(counter, current, target);
                     counter.dataset.currentValue = target;
                 } else { counter.textContent = target; } // Fallback
             });
         }
        // L'animation initiale est déclenchée par websocket.js après la connexion
        // On peut la lancer ici aussi pour un effet immédiat au chargement initial
        animateAllDashboardCounters();


        // 3. Refresh Button
        const refreshButton = document.getElementById('refresh-dashboard');
        if (refreshButton) {
            refreshButton.addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-sync-alt fa-spin me-2"></i>Actualisation...';
                 // Utilise les fonctions de mise à jour de websocket.js
                 if (typeof updateStatsCounters === 'function' && typeof refreshRecentActivity === 'function' && typeof initializeCharts === 'function') {
                    Promise.all([ updateStatsCounters(), refreshRecentActivity(), initializeCharts() ])
                        .then(() => { if (typeof showToast === 'function') showToast('Données actualisées.', 'success'); })
                        .catch(err => { console.error("Refresh error:", err); if (typeof showToast === 'function') showToast('Erreur actualisation.', 'danger'); })
                        .finally(() => { this.disabled = false; this.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Actualiser'; });
                 } else {
                     console.warn("Real-time update functions not found, reloading page.");
                     window.location.reload(); // Fallback
                 }
            });
        }

         // 4. Modal Tab Activation for Attente/Pending
        const participantModals = document.querySelectorAll('[id^="participantsModal"]');
        participantModals.forEach(modal => {
            modal.addEventListener('show.bs.modal', function (event) {
                 const triggerButton = event.relatedTarget;
                 const sessionId = modal.id.replace('participantsModal','');
                 let targetTabId = '#inscrits-tab' + sessionId;
                 if (triggerButton && triggerButton.dataset.showTab === 'attente') { targetTabId = '#attente-tab' + sessionId; }
                 else if (triggerButton && triggerButton.dataset.showTab === 'pending') { targetTabId = '#pending-tab' + sessionId; }
                 const targetTab = modal.querySelector(targetTabId);
                 if(targetTab) { try { new bootstrap.Tab(targetTab).show(); } catch (e) { console.error("Tab error:", e); } }
                 // Rafraîchir les données de la modale quand elle s'ouvre
                 if (typeof updateParticipantModalData === 'function') { updateParticipantModalData(sessionId); }
             });
         });

         // 5. Waitlist Button Intent
        const inscriptionModals = document.querySelectorAll('[id^="inscriptionModal"]');
         inscriptionModals.forEach(modal => {
             modal.addEventListener('show.bs.modal', function (event) {
                 const triggerButton = event.relatedTarget;
                 const defaultTabId = '#existant-tab' + modal.id.replace('inscriptionModal', '');
                 const defaultTab = modal.querySelector(defaultTabId);
                 if (defaultTab) { try { new bootstrap.Tab(defaultTab).show(); } catch (e) { console.error("Tab error:", e); } }
                 if (triggerButton && triggerButton.dataset.goToAttente === 'true') { if (config.debugMode) console.log('Modal opened for waitlist:', modal.id); }
             });
         });

         // 6. Confirmation Logic
        document.body.addEventListener('click', function(e) {
            if (e.target.matches('.btn-cancel-inscription') || e.target.closest('.btn-cancel-inscription')) {
                e.preventDefault();
                const button = e.target.closest('.btn-cancel-inscription');
                const form = button.closest('form');
                if (form && typeof showConfirmation === 'function') {
                    showConfirmation("Êtes-vous sûr de vouloir annuler cette inscription confirmée ?", () => form.submit());
                } else if (form) { if (confirm("Êtes-vous sûr de vouloir annuler cette inscription confirmée ?")) form.submit(); }
            }
            // Ajouter ici d'autres logiques de confirmation (ex: suppression)
        });

        // 7. Specific Modal Fixes (Complémentaire à layout.html)
         function applyDashboardModalFixes() {
            document.querySelectorAll('.modal select, .modal .form-select').forEach(select => { select.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; z-index: 2000 !important; position: relative !important; pointer-events: auto !important; -webkit-appearance: listbox !important; appearance: listbox !important;'; });
             document.querySelectorAll('.modal button, .modal .btn').forEach(button => { button.style.cssText = 'position: relative !important; z-index: 2001 !important; pointer-events: auto !important;'; });
            const closeButtons = document.querySelectorAll('.modal .btn-close');
            closeButtons.forEach(btn => btn.style.zIndex = '2005 !important');
             if (config.debugMode) console.log('Dashboard specific modal JS fixes applied.');
         }
         setTimeout(applyDashboardModalFixes, 300);

         // Le chargement initial des graphiques est géré dans websocket.js après connexion

    });
</script>
{% endblock %}