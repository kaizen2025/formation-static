{% extends "layout.html" %}

{% block content %}
<h1 class="mb-4"><i class="fas fa-users me-2"></i>Gestion des participants</h1>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Ajouter un participant</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('add_participant') }}" method="post" class="row g-3">
                    <div class="col-md-6">
                        <label for="nom" class="form-label">Nom</label>
                        <input type="text" class="form-control" id="nom" name="nom" required>
                    </div>
                    <div class="col-md-6">
                        <label for="prenom" class="form-label">Prénom</label>
                        <input type="text" class="form-control" id="prenom" name="prenom" required>
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="col-md-6">
                        <label for="service_id" class="form-label">Service</label>
                        <select class="form-select" id="service_id" name="service_id" required>
                            <option value="">-- Choisir un service --</option>
                            {% for service in services %}
                            <option value="{{ service.id }}">{{ service.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus-circle me-2"></i>Ajouter le participant
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Tableau des participants -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-list me-2"></i>Liste des participants
        </h6>
        <div class="input-group w-50">
            <input type="text" class="form-control" placeholder="Rechercher un participant..." id="searchParticipant">
            <button class="btn btn-outline-secondary" type="button" id="btnSearch">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="participants-table">
                <thead class="table-light">
                    <tr>
                        <th>Nom</th>
                        <th>Service</th>
                        <th>Email</th>
                        <th class="text-center">Inscriptions</th>
                        <th class="text-center">En attente</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for participant in participants %}
                    <tr data-participant-id="{{ participant.id }}">
                        <td>
                            <div class="fw-bold">{{ participant.prenom }} {{ participant.nom }}</div>
                        </td>
                        <td>
                            <span class="service-badge {{ participant.service_id }}"></span>
                            {{ participant.service.nom }}
                        </td>
                        <td>{{ participant.email }}</td>
                        <td class="text-center">
                            <span class="badge bg-primary">{{ participant.inscriptions|selectattr('statut', 'equalto', 'confirmé')|list|length }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-warning text-dark">{{ participant.liste_attente|length }}</span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary btn-participant" data-bs-toggle="modal" data-bs-target="#viewParticipantModal{{ participant.id }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-warning btn-participant" data-bs-toggle="modal" data-bs-target="#editParticipantModal{{ participant.id }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            
                            <!-- Modal Voir Participant -->
                            <div class="modal fade" id="viewParticipantModal{{ participant.id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">
                                                {{ participant.prenom }} {{ participant.nom }}
                                                <small class="text-muted d-block">{{ participant.email }}</small>
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <!-- Informations du participant -->
                                            <div class="row mb-4">
                                                <div class="col-md-6">
                                                    <h6 class="fw-bold">Service :</h6>
                                                    <p>
                                                        <span class="service-badge {{ participant.service_id }}"></span>
                                                        {{ participant.service.nom }}
                                                    </p>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="fw-bold">Responsable :</h6>
                                                    <p>{{ participant.service.responsable }}</p>
                                                    <p><a href="mailto:{{ participant.service.email_responsable }}">{{ participant.service.email_responsable }}</a></p>
                                                </div>
                                            </div>
                                            
                                            <!-- Onglets pour inscriptions -->
                                            <ul class="nav nav-tabs" id="participantTabs{{ participant.id }}" role="tablist">
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link active" id="inscriptions-tab{{ participant.id }}" data-bs-toggle="tab" data-bs-target="#inscriptions{{ participant.id }}" type="button" role="tab">
                                                        Inscriptions <span class="badge bg-primary ms-1">{{ participant.inscriptions|length }}</span>
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="attente-tab{{ participant.id }}" data-bs-toggle="tab" data-bs-target="#attente{{ participant.id }}" type="button" role="tab">
                                                        Liste d'attente <span class="badge bg-warning text-dark ms-1">{{ participant.liste_attente|length }}</span>
                                                    </button>
                                                </li>
                                            </ul>
                                            <div class="tab-content mt-3" id="participantTabsContent{{ participant.id }}">
                                                <!-- Onglet inscriptions -->
                                                <div class="tab-pane fade show active" id="inscriptions{{ participant.id }}" role="tabpanel">
                                                    {% if participant.inscriptions|length > 0 %}
                                                    <div class="table-responsive">
                                                        <table class="table table-striped">
                                                            <thead>
                                                                <tr>
                                                                    <th>Session</th>
                                                                    <th>Date</th>
                                                                    <th>Horaire</th>
                                                                    <th>Statut</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for inscription in participant.inscriptions %}
                                                                <tr>
                                                                    <td>
                                                                        <span class="badge {% if inscription.session.theme.nom == 'Communiquer avec Teams' %}theme-comm{% elif inscription.session.theme.nom == 'Gérer les tâches (Planner)' %}theme-planner{% elif inscription.session.theme.nom == 'Gérer mes fichiers (OneDrive/SharePoint)' %}theme-onedrive{% elif inscription.session.theme.nom == 'Collaborer avec Teams' %}theme-sharepoint{% endif %}">
                                                                            {{ inscription.session.theme.nom }}
                                                                        </span>
                                                                    </td>
                                                                    <td>{{ inscription.session.formatage_date }}</td>
                                                                    <td>{{ inscription.session.formatage_horaire }}</td>
                                                                    <td>
                                                                        {% if inscription.statut == 'confirmé' %}
                                                                        <span class="badge bg-success">Confirmé</span>
                                                                        {% elif inscription.statut == 'en attente' %}
                                                                        <span class="badge bg-warning">En attente</span>
                                                                        {% else %}
                                                                        <span class="badge bg-danger">Annulé</span>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if inscription.statut == 'confirmé' %}
                                                                        <a href="{{ url_for('generer_invitation', inscription_id=inscription.id) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                                            <i class="far fa-calendar-plus me-1"></i>Invitation
                                                                        </a>
                                                                        {% elif inscription.statut == 'en attente' %}
                                                                        <div class="btn-group btn-group-sm">
                                                                            <form action="{{ url_for('validation_inscription', inscription_id=inscription.id) }}" method="post" class="d-inline">
                                                                                <input type="hidden" name="action" value="valider">
                                                                                <button type="submit" class="btn btn-sm btn-success">
                                                                                    <i class="fas fa-check me-1"></i>Valider
                                                                                </button>
                                                                            </form>
                                                                            <form action="{{ url_for('validation_inscription', inscription_id=inscription.id) }}" method="post" class="d-inline">
                                                                                <input type="hidden" name="action" value="refuser">
                                                                                <button type="submit" class="btn btn-sm btn-danger">
                                                                                    <i class="fas fa-times me-1"></i>Refuser
                                                                                </button>
                                                                            </form>
                                                                        </div>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    {% else %}
                                                    <div class="alert alert-info">
                                                        <i class="fas fa-info-circle me-2"></i>Aucune inscription pour ce participant.
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                
                                                <!-- Onglet liste d'attente -->
                                                <div class="tab-pane fade" id="attente{{ participant.id }}" role="tabpanel">
                                                    {% if participant.liste_attente|length > 0 %}
                                                    <div class="table-responsive">
                                                        <table class="table table-striped">
                                                            <thead>
                                                                <tr>
                                                                    <th>Session</th>
                                                                    <th>Date</th>
                                                                    <th>Position</th>
                                                                    <th>Date d'inscription</th>
                                                                    <th>Statut</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for attente in participant.liste_attente %}
                                                                <tr>
                                                                    <td>
                                                                        <span class="badge {% if attente.session.theme.nom == 'Communiquer avec Teams' %}theme-comm{% elif attente.session.theme.nom == 'Gérer les tâches (Planner)' %}theme-planner{% elif attente.session.theme.nom == 'Gérer mes fichiers (OneDrive/SharePoint)' %}theme-onedrive{% elif attente.session.theme.nom == 'Collaborer avec Teams' %}theme-sharepoint{% endif %}">
                                                                            {{ attente.session.theme.nom }}
                                                                        </span>
                                                                    </td>
                                                                    <td>{{ attente.session.formatage_date }}</td>
                                                                    <td>
                                                                        <span class="badge bg-secondary">{{ attente.position }}</span>
                                                                    </td>
                                                                    <td>{{ attente.date_inscription.strftime('%d/%m/%Y %H:%M') }}</td>
                                                                    <td>
                                                                        {% if attente.notification_envoyee %}
                                                                        <span class="badge bg-info">Notifié</span>
                                                                        {% else %}
                                                                        <span class="badge bg-warning text-dark">En attente</span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    {% else %}
                                                    <div class="alert alert-info">
                                                        <i class="fas fa-info-circle me-2"></i>Aucune inscription en liste d'attente pour ce participant.
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Modal Modifier Participant -->
                            <div class="modal fade" id="editParticipantModal{{ participant.id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Modifier le participant</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form action="{{ url_for('update_participant', id=participant.id) }}" method="post">
                                                <div class="mb-3">
                                                    <label for="nom{{ participant.id }}" class="form-label">Nom</label>
                                                    <input type="text" class="form-control" id="nom{{ participant.id }}" name="nom" value="{{ participant.nom }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="prenom{{ participant.id }}" class="form-label">Prénom</label>
                                                    <input type="text" class="form-control" id="prenom{{ participant.id }}" name="prenom" value="{{ participant.prenom }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="email{{ participant.id }}" class="form-label">Email</label>
                                                    <input type="email" class="form-control" id="email{{ participant.id }}" name="email" value="{{ participant.email }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="service_id{{ participant.id }}" class="form-label">Service</label>
                                                    <select class="form-select" id="service_id{{ participant.id }}" name="service_id" required>
                                                        {% for service in services %}
                                                        <option value="{{ service.id }}" {% if service.id == participant.service_id %}selected{% endif %}>{{ service.nom }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="d-grid">
                                                    <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Recherche de participants
        const searchInput = document.getElementById('searchParticipant');
        const btnSearch = document.getElementById('btnSearch');
        const participantsTable = document.getElementById('participants-table');
        
        function filterParticipants() {
            const searchValue = searchInput.value.toLowerCase();
            const rows = participantsTable.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const name = row.querySelector('td:first-child').textContent.toLowerCase();
                const service = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const email = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                
                if (name.includes(searchValue) || service.includes(searchValue) || email.includes(searchValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        if (searchInput && btnSearch) {
            searchInput.addEventListener('keyup', filterParticipants);
            btnSearch.addEventListener('click', filterParticipants);
        }
        
        // Corrige le problème des modals qui scintillent
        const buttons = document.querySelectorAll('.btn-participant');
        buttons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Récupérer l'ID de la modal ciblée
                const targetId = this.getAttribute('data-bs-target');
                if (!targetId) return;
                
                const modalElement = document.querySelector(targetId);
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                }
            });
        });
    });
</script>
{% endblock %}