<!-- templates/modals/_participants_modal.html -->
{#
    Expects in context:
    - session: The session object.
    - current_user: The logged-in user object.
    - count_confirmed: Pre-calculated count (passed via 'with')
    - count_pending: Pre-calculated count (passed via 'with')
    - count_waitlist: Pre-calculated count (passed via 'with')
#}
<div class="modal fade" id="participantsModal{{ session.id }}" tabindex="-1" aria-labelledby="participantsModalLabel{{ session.id }}" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                 <h5 class="modal-title" id="participantsModalLabel{{ session.id }}">
                    <i class="fas fa-users me-2"></i>Participants - {{ session.theme.nom }}
                    <small class="text-muted d-block fw-normal">{{ session.formatage_date }} | {{ session.formatage_horaire }}</small>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer" style="z-index: 2005 !important; position: relative !important;"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs Navigation -->
                <ul class="nav nav-tabs mb-3" id="participantsTab{{ session.id }}" role="tablist">
                    {# ***** FIX: Use passed counts ***** #}
                    <li class="nav-item" role="presentation">
                         <button class="nav-link active" id="inscrits-tab{{ session.id }}" data-bs-toggle="tab" data-bs-target="#inscritsContent{{ session.id }}" type="button" role="tab" aria-controls="inscritsContent{{ session.id }}" aria-selected="true" style="z-index: 2001 !important; position: relative !important;">
                            <i class="fas fa-check-circle me-1 text-success"></i>Inscrits <span class="badge bg-success ms-1">{{ count_confirmed|default(0) }}</span>
                        </button>
                    </li>
                     <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pending-tab{{ session.id }}" data-bs-toggle="tab" data-bs-target="#pendingContent{{ session.id }}" type="button" role="tab" aria-controls="pendingContent{{ session.id }}" aria-selected="false" style="z-index: 2001 !important; position: relative !important;">
                            <i class="fas fa-hourglass-half me-1 text-secondary"></i>En Attente <span class="badge bg-secondary ms-1">{{ count_pending|default(0) }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="attente-tab{{ session.id }}" data-bs-toggle="tab" data-bs-target="#attenteContent{{ session.id }}" type="button" role="tab" aria-controls="attenteContent{{ session.id }}" aria-selected="false" style="z-index: 2001 !important; position: relative !important;">
                            <i class="fas fa-clock me-1 text-warning"></i>Liste d'attente <span class="badge bg-warning text-dark ms-1">{{ count_waitlist|default(0) }}</span>
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="participantsTabContent{{ session.id }}">
                    <!-- Tab: Confirmed Participants -->
                    <div class="tab-pane fade show active" id="inscritsContent{{ session.id }}" role="tabpanel" aria-labelledby="inscrits-tab{{ session.id }}">
                        {# ***** FIX: Use passed count ***** #}
                        {% if count_confirmed > 0 %}
                        <div class="table-responsive">
                            <p class="small text-muted mb-1">Participants dont l'inscription est confirmée.</p>
                            <table class="table table-striped table-sm align-middle">
                                <thead><tr><th>Participant</th><th>Service</th><th>Email</th><th>Actions</th></tr></thead>
                                <tbody id="inscrits-list-{{session.id}}">
                                    {# Fetch and sort using Jinja filter #}
                                    {% for inscription in session.inscriptions.filter_by(statut='confirmé').all()|sort(attribute='participant.nom') %}
                                    <tr data-inscription-id="{{ inscription.id }}">
                                        <td>{{ inscription.participant.prenom }} {{ inscription.participant.nom }}</td>
                                        <td><span class="service-badge {{ inscription.participant.service.id }}" style="background-color: {{ inscription.participant.service.couleur or '#6c757d' }};"></span> {{ inscription.participant.service.nom }}</td>
                                        <td><a href="mailto:{{ inscription.participant.email }}" title="Envoyer un email">{{ inscription.participant.email }}</a></td>
                                        <td class="actions-cell">
                                            <a href="{{ url_for('generer_invitation', inscription_id=inscription.id) }}" class="btn btn-sm btn-outline-primary" target="_blank" title="Générer invitation Outlook" style="z-index: 2001 !important; position: relative !important; pointer-events: auto !important;"><i class="far fa-calendar-plus"></i> <span class="d-none d-md-inline">Outlook</span></a>
                                             {% if current_user.is_authenticated and current_user.role == 'admin' %}
                                             <form action="{{ url_for('validation_inscription', inscription_id=inscription.id) }}" method="post" class="d-inline ms-1"><input type="hidden" name="action" value="annuler"><button type="button" class="btn btn-sm btn-outline-danger btn-cancel-inscription" title="Annuler l'inscription" style="z-index: 2001 !important; position: relative !important; pointer-events: auto !important;"><i class="fas fa-user-minus"></i></button></form>
                                             {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-light text-center border mt-2"><i class="fas fa-info-circle me-2"></i>Aucun participant confirmé.</div>
                        {% endif %}
                    </div>

                    <!-- Tab: Pending Validation -->
                    <div class="tab-pane fade" id="pendingContent{{ session.id }}" role="tabpanel" aria-labelledby="pending-tab{{ session.id }}">
                         {# ***** FIX: Use passed count ***** #}
                        {% if count_pending > 0 %}
                        <div class="table-responsive">
                             <p class="small text-muted mb-1">Participants en attente de validation.</p>
                            <table class="table table-striped table-sm align-middle">
                                <thead><tr><th>Participant</th><th>Service</th><th>Demandé le</th><th>Actions (Admin/Resp.)</th></tr></thead>
                                <tbody id="pending-list-{{session.id}}">
                                     {% for inscription in session.inscriptions.filter_by(statut='en attente').order_by(Inscription.date_inscription.desc()).all() %}
                                    <tr data-inscription-id="{{ inscription.id }}">
                                        <td>{{ inscription.participant.prenom }} {{ inscription.participant.nom }}</td>
                                        <td><span class="service-badge {{ inscription.participant.service.id }}" style="background-color: {{ inscription.participant.service.couleur or '#6c757d' }};"></span> {{ inscription.participant.service.nom }}</td>
                                        <td>{{ inscription.date_inscription.strftime('%d/%m/%y %H:%M') }}</td>
                                        <td class="actions-cell">
                                            {% if current_user.is_authenticated and current_user.role in ['admin', 'responsable'] and (current_user.role == 'admin' or current_user.service_id == inscription.participant.service_id) %}
                                             <div class="btn-group btn-group-sm">
                                                <form action="{{ url_for('validation_inscription', inscription_id=inscription.id) }}" method="post" class="d-inline"><input type="hidden" name="action" value="valider"><button type="submit" class="btn btn-success" title="Valider" style="z-index: 2001 !important; position: relative !important; pointer-events: auto !important;"><i class="fas fa-check"></i></button></form>
                                                <form action="{{ url_for('validation_inscription', inscription_id=inscription.id) }}" method="post" class="d-inline"><input type="hidden" name="action" value="refuser"><button type="submit" class="btn btn-danger" title="Refuser" style="z-index: 2001 !important; position: relative !important; pointer-events: auto !important;"><i class="fas fa-times"></i></button></form>
                                            </div>
                                             {% else %} <span class="text-muted fst-italic small">Validation requise</span> {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                         <div class="alert alert-light text-center border mt-2"><i class="fas fa-info-circle me-2"></i>Aucune inscription en attente.</div>
                        {% endif %}
                    </div>

                    <!-- Tab: Waitlist -->
                    <div class="tab-pane fade" id="attenteContent{{ session.id }}" role="tabpanel" aria-labelledby="attente-tab{{ session.id }}">
                         {# ***** FIX: Use passed count ***** #}
                        {% if count_waitlist > 0 %}
                        <div class="table-responsive">
                            <p class="small text-muted mb-1">Participants sur la liste d'attente.</p>
                            <table class="table table-striped table-sm align-middle">
                                <thead><tr><th>Pos.</th><th>Participant</th><th>Service</th><th>Inscrit le</th><th>Statut</th>{% if current_user.is_authenticated and current_user.role == 'admin' %}<th>Actions</th>{% endif %}</tr></thead>
                                 <tbody id="attente-list-{{session.id}}">
                                     {% for attente in session.liste_attente.order_by(ListeAttente.position).all() %}
                                    <tr data-attente-id="{{ attente.id }}">
                                        <td><span class="badge bg-secondary">{{ attente.position }}</span></td>
                                        <td>{{ attente.participant.prenom }} {{ attente.participant.nom }}</td>
                                        <td><span class="service-badge {{ attente.participant.service.id }}" style="background-color: {{ attente.participant.service.couleur or '#6c757d' }};"></span> {{ attente.participant.service.nom }}</td>
                                        <td>{{ attente.date_inscription.strftime('%d/%m/%y %H:%M') }}</td>
                                        <td>{% if attente.notification_envoyee %} <span class="badge bg-info" title="Notifié">Notifié</span>{% else %} <span class="badge bg-light text-dark border">En attente</span> {% endif %}</td>
                                         {% if current_user.is_authenticated and current_user.role == 'admin' %}<td class="actions-cell"> <span class="text-muted fst-italic small">Gérer via admin</span> </td>{% endif %}
                                    </tr>
                                    {% endfor %}
                                 </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-light text-center border mt-2"><i class="fas fa-info-circle me-2"></i>Aucune liste d'attente.</div>
                        {% endif %}
                    </div>

                </div> {# End Tab Content #}
            </div> {# End Modal Body #}
            <div class="modal-footer bg-light">
                 <button type="button" class="btn btn-primary me-auto" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#inscriptionModal{{ session.id }}" style="z-index: 2001 !important; position: relative !important; pointer-events: auto !important;"><i class="fas fa-user-plus me-1"></i>Ajouter / Inscrire</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="z-index: 2001 !important; position: relative !important; pointer-events: auto !important;">Fermer</button>
            </div>
        </div>
    </div>
</div>