<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- CSRF Token (Décommentez si vous utilisez Flask-WTF ou similaire) -->
    <!-- <meta name="csrf-token" content="{{ csrf_token() }}"> -->

    <title>{% block title %}{{ app_name | default('Gestion Formation') }}{% endblock %}</title>

    <!-- Favicon (Remplacez par votre chemin) -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

    <!-- Bootstrap CSS (Version 5.3.x recommandée) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- Font Awesome (Version 6.x recommandée) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Styles personnalisés consolidés -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}"> <!-- Inclut les styles des graphiques -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal-fixes.css') }}"> <!-- Inclut les correctifs modales -->

    {% block head_extra %}{% endblock %} {# Pour CSS spécifique à une page #}

    <style>
        /* Style pour le spinner de chargement global */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.85);
            z-index: 10000; /* Au-dessus de tout */
            display: flex; /* Affiché par défaut, caché par JS */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.3s ease-out;
        }
        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .loading-text {
            margin-top: 1rem;
            font-size: 1.1rem;
            color: var(--bs-primary, #0d6efd); /* Utilise la variable Bootstrap si disponible */
        }
        /* Structure Flex pour pousser le footer en bas */
        body {
            padding-top: 70px; /* Ajuster selon la hauteur de votre navbar fixe */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .content-wrapper {
            flex: 1; /* Le contenu principal prend l'espace disponible */
        }
        /* Style pour les toasts */
        .toast-container {
             z-index: 1100 !important; /* S'assurer que les toasts sont au-dessus des modales */
        }
    </style>
</head>
<body>
    <!-- Spinner de chargement global -->
    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
        </div>
        <p class="loading-text">Chargement...</p>
    </div>

    <!-- Barre de navigation -->
    {% include 'partials/_navbar.html' ignore missing %} {# ignore missing évite une erreur si le partial n'existe pas #}

    <!-- Contenu principal -->
    <div class="container-fluid mt-4 content-wrapper" id="main-content">
        {# Affichage des messages Flash #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="row justify-content-center mb-3">
                    <div class="col-md-10 col-lg-8">
                        {% for category, message in messages %}
                            {# Utiliser 'warning' pour 'info' pour une meilleure visibilité #}
                            {% set alert_category = 'warning' if category == 'info' else category %}
                            <div class="alert alert-{{ alert_category }} alert-dismissible fade show shadow-sm" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endwith %}

        {# Bloc de contenu spécifique à la page #}
        {% block content %}{% endblock %}
    </div>

    <!-- Pied de page -->
    {% include 'partials/_footer.html' ignore missing %}

    <!-- Modales communes (si elles sont utilisées sur plusieurs pages) -->
    {% block modals %}
        {# Inclure les modales ici si nécessaire, ex: #}
        {# {% include 'modals/_inscription_modal.html' ignore missing %} #}
        {# {% include 'modals/_participants_modal.html' ignore missing %} #}
        {# {% include 'modals/_attribuer_salle_modal.html' ignore missing %} #}
    {% endblock %}

    <!-- Conteneur pour les Toasts/Notifications -->
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3">
        <!-- Les toasts seront ajoutés ici par JavaScript -->
    </div>

    <!-- Scripts JavaScript -->
    <!-- Bootstrap JS Bundle (inclut Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <!-- Chart.js (Décommentez si vous utilisez des graphiques dynamiques Chart.js) -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script> -->

    <!-- Scripts personnalisés (l'ordre est important) -->
    <script src="{{ url_for('static', filename='js/api-error-handler.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/modal-fix.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/modal-fix-patch.js') }}" defer></script>

    <!-- Configuration JS (si nécessaire, avant dashboard-init) -->
    <script>
        window.dashboardConfig = window.dashboardConfig || {}; // Assure que l'objet existe
        // Passer des variables Flask à JS (exemple)
        window.dashboardConfig.debugMode = {{ debug_mode | default(false) | tojson }};
        // Ajoutez d'autres configurations si nécessaire
        // window.dashboardConfig.baseApiUrl = "{{ url_for('index') }}api";
    </script>

    <script src="{{ url_for('static', filename='js/dashboard-init.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/dashboard-core.js') }}" defer></script>
    {# dashboard-core-fix.js n'est plus inclus #}

    {% block scripts_extra %}{% endblock %} {# Pour JS spécifique à une page #}

    <!-- Script final pour gérer le loader et initialiser les tooltips -->
    <script>
        function hideGlobalLoader() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay && !overlay.classList.contains('hidden')) {
                overlay.classList.add('hidden');
                // Optionnel: supprimer après transition
                // setTimeout(() => { overlay.remove(); }, 300);
            }
        }

        // Cacher le loader une fois que le DOM est prêt et les scripts defer exécutés
        // ou après un timeout de sécurité.
        let loaderHidden = false;
        const hideLoaderTimeout = setTimeout(() => {
            if (!loaderHidden) {
                hideGlobalLoader();
                console.warn("Layout.html: Forcing loading overlay hide (fallback timeout).");
                loaderHidden = true;
            }
        }, 7000); // 7 secondes

        // Essayer de cacher plus tôt si possible
        window.addEventListener('load', () => {
             // 'load' attend toutes les ressources (images, etc.)
             // On donne un petit délai pour que dashboard-core puisse potentiellement
             // indiquer qu'il est en train de charger des données initiales.
            setTimeout(() => {
                const isUpdating = window.dashboardCore && window.dashboardCore.getState && window.dashboardCore.getState().updating;
                if (!isUpdating && !loaderHidden) {
                    hideGlobalLoader();
                    loaderHidden = true;
                    clearTimeout(hideLoaderTimeout); // Annuler le timeout de sécurité
                }
            }, 200);
        });
        // Si dashboard-core finit son chargement initial avant 'window.load'
        document.addEventListener('dashboardDataRefreshed', () => {
             if (!loaderHidden) {
                 hideGlobalLoader();
                 loaderHidden = true;
                 clearTimeout(hideLoaderTimeout);
             }
        }, { once: true }); // Écouter une seule fois

        // Initialiser les tooltips Bootstrap après le chargement du DOM
        document.addEventListener('DOMContentLoaded', function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                // S'assurer de ne pas réinitialiser un tooltip existant
                if (!bootstrap.Tooltip.getInstance(tooltipTriggerEl)) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                }
                return bootstrap.Tooltip.getInstance(tooltipTriggerEl);
            })
        });
    </script>

</body>
</html>
